## Задача: интеграция Uniswap V3 коннектора в основной поток данных

1. **Инвентаризация текущего скрипта**
   - Разобрать `test_scripts/uniswap/v3/connect_uniswap_v3_all.go`: цепочка подписки, зависимые файлы, ожидания по .env и структурам логов.
   - Зафиксировать ключевые вычисления (sqrtPriceX96 → price, нормализация decimals, derivation WETH→USD) и то, что нужно сохранить без регрессий.

2. **Проектирование размещения внутри `internal/dex/Etherium/Uniswap`**
   - Определить пакет (например, `internal/dex/Etherium/Uniswap/v3_connector`) и разделение на файлы: подписка/WS, обработка событий, метаданные, USD-деривация.
   - Продумать публичный интерфейс коннектора, совместимый с core (инициализация по конфигу, запуск воркера, graceful shutdown).

3. **Перенос исходного кода без потери логики**
   - Физически переместить существующий скрипт в новый пакет, сохранив функции, структуры и расчёты.
   - Минимизировать изменения: адаптировать импорты и инициализацию под пакетный режим вместо `main`, добавить зависимость от общего логгера.

4. **Адаптация к конфигам и источникам данных**
   - Расширить `internal/config` и YAML (например, `configs/screener-core.yaml`) для описания Uniswap V3: WS/HTTP RPC, путь к списку пулов, батчи подписок.
   - Подготовить загрузку пулов через общий механизм (в т.ч. поддержка `Temp/geckoterminal_pools.json` и overrides по env).

5. **Интеграция с пайплайном данных**
   - Подключить коннектор к супервизору `cmd/screener-core` с передачей канала `MarketData`.
   - Конвертировать события Swap в стандартные структуры (`pkg/common` / protobuf), нормализовать символы, подписать на Redis-пайплайн.

6. **USD деривация и прайсинг**
   - **6.1. Единый графовый прайс-агрегатор** – вынести расчёт USD в общую подсистему `internal/dex/pricing`, хранить направленные рёбра цен из всех DEX.
   - **6.2. Живые котировки без предположений** – обновлять веса рёбер только реальными swap-ценами, запрещено фиксировать стейблы в 1.0 или усреднять значения.
   - **6.3. Маршруты до USD-якорей** – для каждого токена строить короткий путь (≤3 хопов) к стейблкоину и публиковать точную цену `TOKENUSD` через общий канал.
   - **6.4. Мульти-якоря и веса** – хранить несколько стейбл-якорей, выбирать актуальный маршрут по “массе” (ликвидность × объём) и свежести события.
   - **6.5. Интеграция V2/V3/V4** – подключить V2/V3 (и будущий V4) к единому агрегатору через `UpdatePair`/`ResolveUSD`, чтобы все коннекторы делились графом.
   - **6.6. Документация** – зафиксировать дизайн USD-прейсера и графа в `docs/project_documentation.md`.

7. **Логирование, метрики, устойчивость**
   - Заменить прямой `log` на общий логгер, добавить метрики (счётчики сообщений, reconnect) по аналогии с V2 коннектором.
   - Реализовать graceful shutdown, обработку backoff и ограничение на параллельные RPC внутри архитектурных паттернов проекта.
   - ✅ Uniswap V3 переведён на `util`-логгер, добавлены счётчики `emitted`/`reconnects`, периодические сводки и журналирование .env-обработки.

8. **Тесты и валидация**
   - Добавить unit-тесты для расчёта цен и USD-деривации, мок RPC для метаданных.
   - Организовать интеграционный тест/скрипт запуска через конфиг, убедиться в корректных записях в Redis и логах.

9. **Документация и опер изменения**
   - Обновить `docs/project_documentation.md` и README с описанием V3 коннектора.
   - При необходимости поправить start/stop-скрипты и инструкции по настройке env (Alchemy ключи, пути к JSON).

10. **План внедрения и отката**
    - Прописать в TODO миграционные шаги: деплой новых конфигов, мониторинг, возможность временного отключения V3 через конфиг.
    - Подготовить fallback/feature flag, чтобы быстро отключить коннектор при проблемах.
